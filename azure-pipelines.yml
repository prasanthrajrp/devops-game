trigger:
- main

pool:
  name: cluster-pool

steps:
- checkout: self

# ğŸ” Login to Docker Hub
- task: Docker@2
  displayName: Login to Docker Hub
  inputs:
    command: login
    containerRegistry: dockerhub-connection

# ğŸ— Build
- task: Docker@2
  displayName: Build web-game image
  inputs:
    command: build
    Dockerfile: 2048-game/Dockerfile
    repository: prasanthrajrp/web-game
    tags: |
      latest
      $(Build.BuildId)

# ğŸš€ Push
- task: Docker@2
  displayName: Push web-game image
  inputs:
    command: push
    repository: prasanthrajrp/web-game
    tags: |
      latest
      $(Build.BuildId)
    containerRegistry: dockerhub-connection

# Update image tag inside app-deploy.yaml
- script: |
    sed -i "s|prasanthrajrp/web-game:latest|prasanthrajrp/web-game:$(Build.BuildId)|" 01_kubernetes_aks/app-deploy.yaml
  displayName: Update image tag in app-deploy.yaml

# Apply updated YAML
- script: |
    kubectl apply -f 01_kubernetes_aks/app-deploy.yaml -n sample-app
  displayName: Deploy web-game to Kubernetes

# Validate rollout
- script: |
    kubectl -n sample-app rollout status deployment/web-game --timeout=60s
  displayName: Verify rollout

